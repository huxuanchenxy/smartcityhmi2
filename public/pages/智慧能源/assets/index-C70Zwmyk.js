import{_ as me,r as o,I as fe,J as d,K as ge,c as C,b as l,w as n,e as s,i as w,t as g,s as _e,L as U,M as ye,N as we,d as c,o as _,F as X,x as Ve,u as D,A as be,O as he,y as F,P as ke,Q as xe,U as Ce}from"./index-CjguSdL3.js";import{d as Z}from"./vuedraggable.umd-B0pI6CdV.js";import{a as Y,G as Ue}from"./energyApi-BelWF7_m.js";const De={class:"container"},Ye={class:"loading-content"},Me={class:"loading-text"},Le={class:"select-area"},Ee={class:"content-area"},Ne={class:"scrollable-list"},Se={class:"draggable-item-disabled"},$e={class:"item-index"},He={class:"item-name"},Te={class:"switch-container"},Be={class:"right-group"},Ie={class:"scrollable-list"},ze={class:"draggable-item"},Pe={class:"item-content"},Re={class:"item-index"},je={key:0,class:"item-name"},Ke={class:"item-actions"},Fe={class:"button-area"},Oe={key:0},Ae={__name:"index",setup(Ge){let O=o(null);const $=o([]),H=o(105);o("");const A=o(!0),u=o(""),T=o([]),B=o([]),f=o([]),I=o(!1),G=o(!1),ee=o(null),V=o(0),z=o(""),P=o("处理中，请稍候..."),R=o("");fe(async()=>{await ae()});const ae=async()=>{let a=await Y.nox_company();a.code==200?$.value=a.data:d.error("nox_company:"+a.msg)},te=a=>{f.value&&f.value.forEach(e=>{e.active=a})},le=async()=>{let a=await Y.csvmap({company:u.value});a.code==200?T.value=a.data:d.error("csvmap:"+a.msg)},j=ge(()=>{const a=$.value.find(e=>e.dictValue===u.value);return a?a.dictLabel:""}),J=o(!0),se=async()=>{u.value&&(await Q(),await oe(),d.success("成功加载 ".concat(j.value," 的数据")))},oe=async()=>{let a=await Y.aodatelist({company:u.value});a.code==200?(K.value=[],a.data&&a.data.length>0&&a.data.forEach(e=>{K.value.push(e.date)})):d.error("加载可用时间段出错:"+a.msg)},Q=async()=>{await le(),B.value=T.value.map((a,e)=>({name:a.colName,no:a.no,active:a.status.toString()=="1"})),f.value=T.value.map((a,e)=>({id:a.id,name:a.colName,no:a.no,col:a.col,editing:!1,editName:"",active:a.status.toString()=="1",sort:a.sort,company:a.company,type:a.type,status:a.status}))},ne=a=>{a.editing=!0,a.editName=a.name},q=a=>{if(!a.editName.trim()){d.warning("名称不能为空");return}a.name=a.editName,a.editing=!1},de=a=>{a.editing=!1},ie=async a=>{const e=a.target.files[0];if(!e)return;G.value=!0,P.value="正在导入 ".concat(e.name,"..."),V.value=0,z.value="";const i=setInterval(()=>{V.value+=Math.floor(Math.random()*5)+1,V.value>=100&&(clearInterval(i),V.value=100,z.value="success",P.value="导入完成!",setTimeout(()=>{a.target.value="",G.value=!1,I.value=!1,d.success("成功导入 ".concat(e.name))},1e3))},100)},M=o(!1);let re=Ue();const ue=async()=>{if(!u.value){d.warning("请先选择工厂名称");return}if(!p.value){d.warning("请选择开始时间");return}if(!v.value){d.warning("请选择结束时间");return}if(p.value>=v.value){d.warning("结束时间要大于开始时间");return}let a=await Y.validateExport({startTime:U(p.value).format("YYYY-MM-DD HH:mm:ss"),endTime:U(v.value).format("YYYY-MM-DD HH:mm:ss"),company:u.value});if(a&&a.data==!1){d.warning("你选择的时间内无数据，请重新选择时间！");return}M.value=!0;try{O.value=ye.service({fullscreen:!0,lock:!0,text:"数据加载中....",background:"rgba(0, 0, 0, 0.1)"});const e=new URLSearchParams({startTime:U(p.value).format("YYYY-MM-DD HH:mm:ss"),endTime:U(v.value).format("YYYY-MM-DD HH:mm:ss"),company:u.value,durationSecond:H.value}),i=await fetch(re+"/noxao/toCsv?".concat(e));if(!i.ok){let r="服务器错误: ".concat(i.status);console.log("errorMessage:",r);try{const t=await i.json();t.message&&(r=t.message)}catch(t){console.error("解析错误信息失败:",t)}throw new Error(r)}const L=i.headers.get("Content-Length"),E=L?parseInt(L):null;let N=0;const S=i.body.getReader(),b=[];for(;;){const{done:r,value:t}=await S.read();if(r)break;if(b.push(t),N+=t.length,E){const x=Math.round(N/E*100);R.value="下载进度: ".concat(x,"%")}}const h=new Blob(b),k=URL.createObjectURL(h),y=document.createElement("a");y.href=k,y.download=j.value+".csv",y.click(),URL.revokeObjectURL(k)}catch(e){console.error("下载失败:",e),d.error("导出失败，失败原因："+e)}finally{M.value=!1,O.value.close(),R.value=""}},ce=async()=>{if(!u.value){d.warning("请先选择工厂名称");return}try{await we.confirm("确定要保存当前列表的更改吗?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),f.value=f.value.map((e,i)=>({id:e.id,colName:e.name,col:e.col,active:e.active,sort:i+1,company:e.company,type:e.type,status:e.active?"1":"0"})),(await Y.csvmapall(f.value)).code==200&&(d.success("成功保存 ".concat(j.value," 的数据")),Q())}catch(a){console.log("取消保存",a)}},pe=()=>{},p=o(""),v=o(""),ve=async()=>{if(p.value&&v.value&&p.value>=v.value){d.warning("开始时间不能大于结束时间"),p.value="",v.value="";return}},K=o([]);function W(a){const e=U(a).format("YYYY-MM-DD");return!K.value.includes(e)}return(a,e)=>{const i=c("el-progress"),L=c("el-dialog"),E=c("el-option"),N=c("el-select"),S=c("el-date-picker"),b=c("el-input"),h=c("el-switch"),k=c("el-card"),y=c("el-icon"),r=c("el-button");return _(),C("div",De,[l(L,{modelValue:I.value,"onUpdate:modelValue":e[0]||(e[0]=t=>I.value=t),title:"处理中",width:"30%","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!1},{default:n(()=>[s("div",Ye,[l(i,{type:"circle",percentage:V.value,status:z.value},null,8,["percentage","status"]),s("p",Me,g(P.value),1)])]),_:1},8,["modelValue"]),s("div",Le,[e[8]||(e[8]=s("span",{class:"promptspan"},"工厂名称：",-1)),l(N,{modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=t=>u.value=t),placeholder:"请选择工厂名称",onChange:se,clearable:"",filterable:""},{default:n(()=>[(_(!0),C(X,null,Ve($.value,t=>(_(),F(E,{key:t.dictCode,label:t.dictLabel,value:t.dictValue},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),e[9]||(e[9]=s("span",{class:"promptspan"},"时间范围：",-1)),l(S,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=t=>p.value=t),type:"datetime",placeholder:"开始时间",style:{width:"100%","max-width":"180px"},"disabled-date":W,align:"right"},null,8,["modelValue"]),e[10]||(e[10]=w(" 至 ")),l(S,{modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=t=>v.value=t),type:"datetime","disabled-date":W,placeholder:"结束时间",onChange:ve,style:{width:"100%","max-width":"180px"},align:"right"},null,8,["modelValue"]),e[11]||(e[11]=s("span",{class:"promptspan"},"时间跨度(s)：",-1)),l(b,{class:"duration-input",modelValue:H.value,"onUpdate:modelValue":e[4]||(e[4]=t=>H.value=t),placeholder:"Enter duration in seconds",type:"number"},null,8,["modelValue"])]),s("div",Ee,[l(k,{class:"original-list"},{header:n(()=>e[12]||(e[12]=[s("h2",null,"变更前的列",-1)])),default:n(()=>[s("div",Ne,[l(D(Z),{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=t=>B.value=t),"item-key":"id",class:be({"disabled-drag":A.value}),disabled:A.value},{item:n(({element:t,index:x})=>[s("div",Se,[s("span",$e,g(x+1)+".",1),s("span",He,g(t.name)+"("+g(t.no)+")",1),l(h,{modelValue:t.active,"onUpdate:modelValue":m=>t.active=m,disabled:""},null,8,["modelValue","onUpdate:modelValue"])])]),_:1},8,["modelValue","class","disabled"])])]),_:1}),l(k,{class:"editable-list"},{header:n(()=>[s("div",Te,[e[14]||(e[14]=s("h2",null,"变更后的列",-1)),s("div",Be,[e[13]||(e[13]=s("span",null,"一键全部开启或关闭",-1)),l(h,{modelValue:J.value,"onUpdate:modelValue":e[6]||(e[6]=t=>J.value=t),onChange:te},null,8,["modelValue"])])])]),default:n(()=>[s("div",Ie,[l(D(Z),{modelValue:f.value,"onUpdate:modelValue":e[7]||(e[7]=t=>f.value=t),"item-key":"id",onEnd:pe},{item:n(({element:t,index:x})=>[s("div",ze,[l(y,{class:"drag-handle"},{default:n(()=>[l(D(he))]),_:1}),s("div",Pe,[s("span",Re,g(x+1)+".",1),t.editing?(_(),F(b,{key:1,modelValue:t.editName,"onUpdate:modelValue":m=>t.editName=m,size:"small",onKeyup:ke(m=>q(t),["enter"]),style:{flex:"1","margin-right":"10px"},class:"edit-input"},null,8,["modelValue","onUpdate:modelValue","onKeyup"])):(_(),C("span",je,g(t.name)+"("+g(t.no)+") ",1)),s("div",Ke,[t.editing?(_(),C(X,{key:1},[l(r,{type:"text",size:"small",onClick:m=>q(t)},{default:n(()=>e[16]||(e[16]=[w(" 确认 ")])),_:2},1032,["onClick"]),l(r,{type:"text",size:"small",onClick:m=>de(t)},{default:n(()=>e[17]||(e[17]=[w(" 取消 ")])),_:2},1032,["onClick"])],64)):(_(),F(r,{key:0,type:"text",size:"small",onClick:m=>ne(t)},{default:n(()=>e[15]||(e[15]=[w(" 编辑 ")])),_:2},1032,["onClick"])),l(h,{modelValue:t.active,"onUpdate:modelValue":m=>t.active=m},null,8,["modelValue","onUpdate:modelValue"])])])])]),_:1},8,["modelValue"])])]),_:1})]),s("div",Fe,[l(r,{type:"success",onClick:ue,loading:M.value},{default:n(()=>[l(y,{class:"el-icon--left"},{default:n(()=>[l(D(xe))]),_:1}),e[18]||(e[18]=w(" 导出并下载 "))]),_:1},8,["loading"]),M.value?(_(),C("span",Oe,g(R.value),1)):_e("",!0),l(r,{type:"warning",onClick:ce},{default:n(()=>[l(y,{class:"el-icon--left"},{default:n(()=>[l(D(Ce))]),_:1}),e[19]||(e[19]=w(" 保存 "))]),_:1}),s("input",{type:"file",ref_key:"fileInput",ref:ee,onChange:ie,accept:".csv",style:{display:"none"}},null,544)])])}}},We=me(Ae,[["__scopeId","data-v-424ee317"]]);export{We as default};
